// This Pine Scriptâ„¢ is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© CompositeAlpha

//@version=5
strategy("ğŸ§¬ Composite Alpha â€” Multi-Regime Mean Reversion", 
     overlay=true, 
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=100,
     initial_capital=100000,
     commission_type=strategy.commission.percent,
     commission_value=0.02,
     slippage=2,
     calc_on_every_tick=false,
     process_orders_on_close=false,
     max_bars_back=500,
     pyramiding=0)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“‹ STRATEGY DESCRIPTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Composite Alpha is a regime-adaptive leveraged strategy that:
// 1. Detects market regime (bull/bear, calm/volatile)
// 2. Adjusts position size based on regime (higher in calm bulls)
// 3. Uses a crash detector to go to cash during drawdowns
// 4. Overlays mean reversion entries on extreme oversold conditions
// 5. Has multiple exit mechanisms (mean reversion, profit target, stop loss)
//
// âš ï¸ IMPORTANT: This uses SIMULATED leverage via position sizing.
//    In real trading, you'd implement leverage via:
//    - Futures (ES, NQ, etc.)
//    - Leveraged ETFs (SSO, QLD, TQQQ â€” NOT recommended long term)
//    - Portfolio margin account
//    - Options (deep ITM calls as stock replacement)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš™ï¸ INPUT PARAMETERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// --- Regime Detection ---
grp1 = "ğŸ” Regime Detection"
sma200_len    = input.int(200, "SMA Length (Trend)", minval=50, maxval=400, step=10, group=grp1)
sma50_len     = input.int(50, "SMA Length (Momentum)", minval=20, maxval=100, step=5, group=grp1)
vol_len       = input.int(20, "Volatility Lookback", minval=10, maxval=60, step=5, group=grp1)
calm_vol      = input.float(14.0, "Calm Vol Threshold %", minval=5, maxval=30, step=1, group=grp1)
high_vol      = input.float(22.0, "High Vol Threshold %", minval=15, maxval=50, step=1, group=grp1)

// --- Leverage / Position Sizing ---
grp2 = "âš¡ Leverage (Position Sizing)"
max_lev       = input.float(3.5, "Max Leverage (Calm Bull)", minval=1, maxval=8, step=0.5, group=grp2)
strong_lev    = input.float(2.8, "Strong Bull Leverage", minval=1, maxval=6, step=0.2, group=grp2)
bull_lev      = input.float(2.0, "Normal Bull Leverage", minval=0.5, maxval=4, step=0.2, group=grp2)
weak_lev      = input.float(1.2, "Weak/Mixed Leverage", minval=0.3, maxval=2, step=0.1, group=grp2)
bear_lev      = input.float(0.3, "Bear Leverage", minval=0, maxval=1, step=0.1, group=grp2)
use_leverage  = input.bool(true, "Enable Leverage Scaling", group=grp2)

// --- Crash Protection ---
grp3 = "ğŸ›¡ï¸ Crash Protection"
crash_thresh  = input.float(6.0, "Crash Threshold % (from peak)", minval=2, maxval=15, step=0.5, group=grp3)
crash_cool    = input.int(8, "Crash Cooldown (bars)", minval=3, maxval=30, step=1, group=grp3)
crash_rsi_re  = input.float(45.0, "RSI for Re-entry", minval=30, maxval=60, step=1, group=grp3)
ema_reentry   = input.int(21, "EMA for Re-entry", minval=10, maxval=50, step=1, group=grp3)
equity_stop   = input.float(25.0, "Equity DD Stop %", minval=10, maxval=50, step=5, group=grp3)

// --- Mean Reversion Overlay ---
grp4 = "ğŸ“‰ Mean Reversion Overlay"
use_mr        = input.bool(true, "Enable Mean Reversion", group=grp4)
bb_len        = input.int(20, "Bollinger Band Length", minval=10, maxval=40, step=2, group=grp4)
bb_mult       = input.float(1.5, "BB Multiplier", minval=1.0, maxval=3.0, step=0.1, group=grp4)
rsi_len       = input.int(14, "RSI Length", minval=7, maxval=21, step=1, group=grp4)
rsi_entry     = input.float(25.0, "RSI Entry Threshold", minval=15, maxval=40, step=1, group=grp4)
rsi_panic     = input.float(18.0, "RSI Panic Entry", minval=10, maxval=30, step=1, group=grp4)
mr_extra_lev  = input.float(1.5, "MR Extra Leverage Boost", minval=0.5, maxval=3, step=0.25, group=grp4)

// --- Exit Rules ---
grp5 = "ğŸšª Exit Rules"
exit_ema_len  = input.int(10, "Exit EMA Length", minval=5, maxval=30, step=1, group=grp5)
profit_target = input.float(7.0, "Profit Target %", minval=2, maxval=20, step=0.5, group=grp5)
stop_loss     = input.float(9.0, "Stop Loss %", minval=3, maxval=20, step=0.5, group=grp5)
atr_len       = input.int(14, "ATR Length", minval=7, maxval=21, step=1, group=grp5)
time_stop     = input.int(25, "Time Stop (bars)", minval=10, maxval=60, step=5, group=grp5)

// --- Rebalance ---
grp6 = "ğŸ”„ Rebalance"
rebal_period  = input.int(15, "Rebalance Period (bars)", minval=5, maxval=60, step=5, group=grp6)

// --- Visual ---
grp7 = "ğŸ¨ Display"
show_regime   = input.bool(true, "Show Regime Background", group=grp7)
show_signals  = input.bool(true, "Show Entry/Exit Signals", group=grp7)
show_levels   = input.bool(true, "Show BB / SMA Levels", group=grp7)
show_table    = input.bool(true, "Show Info Table", group=grp7)


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š INDICATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Trend
sma200 = ta.sma(close, sma200_len)
sma50  = ta.sma(close, sma50_len)
ema_re = ta.ema(close, ema_reentry)
ema_ex = ta.ema(close, exit_ema_len)

// Volatility â€” Annualized
daily_ret  = math.log(close / close[1])
hist_vol   = ta.stdev(daily_ret, vol_len) * math.sqrt(252) * 100

// RSI
rsi = ta.rsi(close, rsi_len)

// Bollinger Bands
bb_basis = ta.sma(close, bb_len)
bb_dev   = ta.stdev(close, bb_len) * bb_mult
bb_upper = bb_basis + bb_dev
bb_lower = bb_basis - bb_dev

// ATR
atr = ta.atr(atr_len)

// Recent peak (for crash detection)
peak20 = ta.highest(close, 20)
drawdown_from_peak = (peak20 - close) / peak20 * 100


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ” REGIME DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

above_sma200 = close > sma200
above_sma50  = close > sma50
golden_cross = sma50 > sma200
vol_calm     = hist_vol < calm_vol
vol_high     = hist_vol > high_vol
vol_normal   = not vol_calm and not vol_high
strong_trend = above_sma200 and above_sma50 and golden_cross

// Regime Classification
regime_calm_bull   = above_sma200 and vol_calm and strong_trend
regime_strong_bull = above_sma200 and strong_trend and not vol_calm
regime_bull        = above_sma200 and not strong_trend
regime_mixed       = not above_sma200 and close > sma200 * 0.95
regime_bear        = close < sma200 * 0.95

// Current Leverage Based on Regime
var float target_lev = 1.0
if use_leverage
    if regime_calm_bull
        target_lev := max_lev
    else if regime_strong_bull
        target_lev := strong_lev
    else if regime_bull
        target_lev := bull_lev
    else if regime_mixed
        target_lev := weak_lev
    else if regime_bear
        target_lev := bear_lev
    else
        target_lev := 1.0
else
    target_lev := 1.0

// Regime label for display
regime_str = regime_calm_bull ? "CALM BULL" : regime_strong_bull ? "STRONG BULL" : regime_bull ? "BULL" : regime_mixed ? "MIXED" : "BEAR"
regime_col = regime_calm_bull ? color.new(#10b981, 0) : regime_strong_bull ? color.new(#3b82f6, 0) : regime_bull ? color.new(#8b5cf6, 0) : regime_mixed ? color.new(#f59e0b, 0) : color.new(#ef4444, 0)


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ›¡ï¸ CRASH DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var bool in_crash = false
var int crash_bar = 0
var bool crash_cooldown = false

crash_trigger = drawdown_from_peak >= crash_thresh

if crash_trigger and not in_crash
    in_crash := true
    crash_bar := bar_index

// Crash re-entry conditions
crash_recovery = close > ema_re and rsi > crash_rsi_re
if in_crash and (bar_index - crash_bar >= crash_cool) and crash_recovery
    in_crash := false

// Equity-based drawdown stop
var float equity_peak = strategy.initial_capital
equity_peak := math.max(equity_peak, strategy.equity)
equity_dd = (equity_peak - strategy.equity) / equity_peak * 100
equity_halve = equity_dd > equity_stop / 2
equity_full_stop = equity_dd > equity_stop


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“‰ MEAN REVERSION SIGNALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

mr_entry = use_mr and close < bb_lower and rsi < rsi_entry
mr_panic = use_mr and rsi < rsi_panic  // Even during crash mode
mr_exit  = close > ema_ex and close > bb_basis


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ POSITION SIZING & ENTRIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var int bars_in_trade = 0
var float entry_price = 0.0
var bool is_mr_trade = false

// Calculate position size as % of equity
float pos_size = target_lev * 100  // e.g., 3.5x = 350% of equity

// Adjustments
if equity_halve
    pos_size := pos_size * 0.5
if equity_full_stop or in_crash
    pos_size := 0

// Mean reversion boost
if mr_entry and not in_crash
    pos_size := math.min((target_lev + mr_extra_lev) * 100, max_lev * 1.5 * 100)

// Panic MR even during crash
if mr_panic and in_crash
    pos_size := bull_lev * 100

// Cap at reasonable maximum
pos_size := math.min(pos_size, max_lev * 1.5 * 100)

// Rebalance logic
should_rebal = bar_index % rebal_period == 0


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ˆ STRATEGY EXECUTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Track trade state
if strategy.position_size > 0
    bars_in_trade += 1
else
    bars_in_trade := 0
    is_mr_trade := false

// === BASE POSITION ENTRIES ===
// Enter/adjust on rebalance days when not in crash
if should_rebal and not in_crash and pos_size > 0 and not equity_full_stop
    if strategy.position_size == 0
        strategy.entry("Base", strategy.long, qty=math.round(pos_size))
        entry_price := close
        is_mr_trade := false
    // Could add rebalancing logic here for size adjustment

// === MEAN REVERSION ENTRIES ===
if mr_entry and strategy.position_size == 0 and not in_crash
    strategy.entry("MR", strategy.long, qty=math.round(pos_size))
    entry_price := close
    is_mr_trade := true

// === PANIC MR (even during crash) ===
if mr_panic and strategy.position_size == 0 and in_crash
    strategy.entry("PanicMR", strategy.long, qty=math.round(bull_lev * 100))
    entry_price := close
    is_mr_trade := true


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸšª EXIT LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if strategy.position_size > 0
    trade_return = (close - entry_price) / entry_price * 100
    
    // 1. CRASH EXIT â€” Immediate
    if crash_trigger and not is_mr_trade
        strategy.close_all("Crash Exit")
    
    // 2. EQUITY STOP â€” Full drawdown
    if equity_full_stop
        strategy.close_all("Equity Stop")
    
    // 3. PROFIT TARGET
    if trade_return >= profit_target
        strategy.close_all("Profit Target âœ…")
    
    // 4. STOP LOSS
    if trade_return <= -stop_loss
        strategy.close_all("Stop Loss âŒ")
    
    // 5. MEAN REVERSION EXIT (for MR trades)
    if is_mr_trade and mr_exit
        strategy.close_all("MR Exit â†©ï¸")
    
    // 6. TIME STOP
    if bars_in_trade >= time_stop
        strategy.close_all("Time Stop â°")
    
    // 7. REGIME SHIFT â€” Bear with no MR
    if regime_bear and not is_mr_trade and not mr_entry
        strategy.close_all("Regime Shift ğŸ»")


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¨ VISUAL OVERLAYS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Regime background
bgcolor(show_regime ? (in_crash ? color.new(#ef4444, 92) : regime_calm_bull ? color.new(#10b981, 94) : regime_strong_bull ? color.new(#3b82f6, 94) : regime_bull ? color.new(#8b5cf6, 95) : regime_mixed ? color.new(#f59e0b, 95) : color.new(#ef4444, 95)) : na)

// SMA Lines
plot(show_levels ? sma200 : na, "SMA 200", color=color.new(#f59e0b, 30), linewidth=2)
plot(show_levels ? sma50 : na, "SMA 50", color=color.new(#3b82f6, 40), linewidth=1)
plot(show_levels ? ema_ex : na, "Exit EMA", color=color.new(#10b981, 50), linewidth=1, style=plot.style_cross)

// Bollinger Bands
p_bbu = plot(show_levels ? bb_upper : na, "BB Upper", color=color.new(#8b5cf6, 60))
p_bbl = plot(show_levels ? bb_lower : na, "BB Lower", color=color.new(#8b5cf6, 60))
fill(p_bbu, p_bbl, color=color.new(#8b5cf6, 94))

// Entry/Exit Signals
plotshape(show_signals and mr_entry and strategy.position_size == 0 ? low : na, "MR Entry", shape.triangleup, location.belowbar, color.new(#10b981, 0), size=size.small)
plotshape(show_signals and mr_panic and strategy.position_size == 0 and in_crash ? low : na, "Panic MR", shape.diamond, location.belowbar, color.new(#f59e0b, 0), size=size.small)
plotshape(show_signals and crash_trigger and strategy.position_size > 0 ? high : na, "Crash Exit", shape.xcross, location.abovebar, color.new(#ef4444, 0), size=size.small)


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š INFO TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_table
    var table infoTable = table.new(position.top_right, 2, 12, bgcolor=color.new(#111827, 10), frame_color=color.new(#1f2937, 0), frame_width=1, border_color=color.new(#1f2937, 0), border_width=1)
    
    if barstate.islast
        table.cell(infoTable, 0, 0, "ğŸ§¬ Composite Alpha", text_color=color.new(#a78bfa, 0), text_size=size.small, text_halign=text.align_left)
        table.cell(infoTable, 1, 0, "v1.0", text_color=color.new(#64748b, 0), text_size=size.tiny, text_halign=text.align_right)
        
        table.cell(infoTable, 0, 1, "Regime", text_color=color.new(#9ca3af, 0), text_size=size.tiny, text_halign=text.align_left)
        table.cell(infoTable, 1, 1, regime_str, text_color=regime_col, text_size=size.tiny, text_halign=text.align_right)
        
        table.cell(infoTable, 0, 2, "Leverage", text_color=color.new(#9ca3af, 0), text_size=size.tiny, text_halign=text.align_left)
        table.cell(infoTable, 1, 2, str.tostring(target_lev, "#.#") + "x", text_color=color.new(#60a5fa, 0), text_size=size.tiny, text_halign=text.align_right)
        
        table.cell(infoTable, 0, 3, "Volatility", text_color=color.new(#9ca3af, 0), text_size=size.tiny, text_halign=text.align_left)
        table.cell(infoTable, 1, 3, str.tostring(hist_vol, "#.#") + "%", text_color=(hist_vol < calm_vol ? color.new(#10b981, 0) : hist_vol > high_vol ? color.new(#ef4444, 0) : color.new(#f59e0b, 0)), text_size=size.tiny, text_halign=text.align_right)
        
        table.cell(infoTable, 0, 4, "RSI", text_color=color.new(#9ca3af, 0), text_size=size.tiny, text_halign=text.align_left)
        table.cell(infoTable, 1, 4, str.tostring(rsi, "#.#"), text_color=(rsi < rsi_entry ? color.new(#10b981, 0) : rsi > 70 ? color.new(#ef4444, 0) : color.new(#e5e7eb, 0)), text_size=size.tiny, text_halign=text.align_right)
        
        table.cell(infoTable, 0, 5, "DD from Peak", text_color=color.new(#9ca3af, 0), text_size=size.tiny, text_halign=text.align_left)
        table.cell(infoTable, 1, 5, str.tostring(drawdown_from_peak, "#.#") + "%", text_color=(drawdown_from_peak > crash_thresh ? color.new(#ef4444, 0) : drawdown_from_peak > crash_thresh/2 ? color.new(#f59e0b, 0) : color.new(#10b981, 0)), text_size=size.tiny, text_halign=text.align_right)
        
        table.cell(infoTable, 0, 6, "Crash Mode", text_color=color.new(#9ca3af, 0), text_size=size.tiny, text_halign=text.align_left)
        table.cell(infoTable, 1, 6, in_crash ? "ğŸ”´ ACTIVE" : "ğŸŸ¢ OFF", text_color=(in_crash ? color.new(#ef4444, 0) : color.new(#10b981, 0)), text_size=size.tiny, text_halign=text.align_right)
        
        table.cell(infoTable, 0, 7, "Equity DD", text_color=color.new(#9ca3af, 0), text_size=size.tiny, text_halign=text.align_left)
        table.cell(infoTable, 1, 7, str.tostring(equity_dd, "#.#") + "%", text_color=(equity_dd > equity_stop ? color.new(#ef4444, 0) : equity_dd > equity_stop/2 ? color.new(#f59e0b, 0) : color.new(#10b981, 0)), text_size=size.tiny, text_halign=text.align_right)
        
        table.cell(infoTable, 0, 8, "Position", text_color=color.new(#9ca3af, 0), text_size=size.tiny, text_halign=text.align_left)
        table.cell(infoTable, 1, 8, strategy.position_size > 0 ? "LONG" : "FLAT", text_color=(strategy.position_size > 0 ? color.new(#10b981, 0) : color.new(#64748b, 0)), text_size=size.tiny, text_halign=text.align_right)
        
        table.cell(infoTable, 0, 9, "Bars in Trade", text_color=color.new(#9ca3af, 0), text_size=size.tiny, text_halign=text.align_left)
        table.cell(infoTable, 1, 9, str.tostring(bars_in_trade), text_color=color.new(#e5e7eb, 0), text_size=size.tiny, text_halign=text.align_right)
        
        table.cell(infoTable, 0, 10, "Equity", text_color=color.new(#9ca3af, 0), text_size=size.tiny, text_halign=text.align_left)
        table.cell(infoTable, 1, 10, "$" + str.tostring(strategy.equity, "#,###"), text_color=color.new(#10b981, 0), text_size=size.tiny, text_halign=text.align_right)
        
        table.cell(infoTable, 0, 11, "Net P&L", text_color=color.new(#9ca3af, 0), text_size=size.tiny, text_halign=text.align_left)
        net_pnl = strategy.netprofit
        table.cell(infoTable, 1, 11, (net_pnl >= 0 ? "+" : "") + "$" + str.tostring(net_pnl, "#,###"), text_color=(net_pnl >= 0 ? color.new(#10b981, 0) : color.new(#ef4444, 0)), text_size=size.tiny, text_halign=text.align_right)


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”” ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(mr_entry and strategy.position_size == 0, "Mean Reversion Entry", "ğŸŸ¢ MR Entry Signal â€” RSI: {{plot_2}} | Close below lower BB")
alertcondition(crash_trigger and strategy.position_size > 0, "Crash Detected", "ğŸ”´ CRASH DETECTED â€” Price dropped {{plot_3}}% from 20-day peak. EXITING ALL.")
alertcondition(mr_panic and in_crash, "Panic Buy Signal", "ğŸŸ¡ Panic MR â€” Extreme oversold during crash. Counter-trend entry.")
alertcondition(regime_calm_bull and not regime_calm_bull[1], "Calm Bull Entered", "ğŸŸ¢ Regime shifted to CALM BULL â€” Max leverage engaged")
alertcondition(regime_bear and not regime_bear[1], "Bear Entered", "ğŸ”´ Regime shifted to BEAR â€” Reducing to minimum exposure")
