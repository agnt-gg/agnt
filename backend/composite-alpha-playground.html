<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ§¬ Composite Alpha v2 â€” Reality-Checked Strategy Playground</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{--bg:#0a0e17;--card:#111827;--border:#1f2937;--text:#e5e7eb;--muted:#9ca3af;--accent:#3b82f6;--green:#10b981;--red:#ef4444;--gold:#f59e0b;--purple:#8b5cf6;--cyan:#06b6d4;--warn:#dc2626}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;font-size:14px}
.header{background:linear-gradient(135deg,#1e1b4b,#0f172a);padding:20px 28px;border-bottom:1px solid var(--border)}
.header h1{font-size:24px;font-weight:800;background:linear-gradient(90deg,#60a5fa,#a78bfa,#f472b6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header p{color:var(--muted);margin-top:4px;font-size:12px}
.warn-banner{background:linear-gradient(90deg,rgba(220,38,38,.15),rgba(245,158,11,.15));border:1px solid rgba(220,38,38,.3);padding:10px 28px;font-size:12px;color:#fbbf24;display:flex;align-items:center;gap:8px}
.warn-banner strong{color:#f87171}
.tabs{display:flex;gap:4px;padding:10px 28px;background:var(--card);border-bottom:1px solid var(--border);overflow-x:auto}
.tab{padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;color:var(--muted);background:transparent;border:1px solid transparent;transition:all .2s;white-space:nowrap}
.tab:hover{color:var(--text);background:rgba(59,130,246,.1)}
.tab.active{color:#60a5fa;background:rgba(59,130,246,.15);border-color:rgba(59,130,246,.3)}
.container{padding:20px 28px;max-width:1440px;margin:0 auto}
.panel{display:none}.panel.active{display:block}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.grid5{display:grid;grid-template-columns:repeat(5,1fr);gap:14px}
@media(max-width:1000px){.grid2,.grid3,.grid4,.grid5{grid-template-columns:1fr 1fr}}
@media(max-width:600px){.grid2,.grid3,.grid4,.grid5{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
.card h3{font-size:11px;color:var(--muted);font-weight:500;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.card .val{font-size:26px;font-weight:800}.card .sub{font-size:10px;color:var(--muted);margin-top:2px}
.card.warn-card{border-color:rgba(220,38,38,.4);background:rgba(220,38,38,.05)}
.card.real-card{border-color:rgba(16,185,129,.4);background:rgba(16,185,129,.05)}
.green{color:var(--green)}.red{color:var(--red)}.gold{color:var(--gold)}.blue{color:var(--accent)}.purple{color:var(--purple)}.warn-text{color:var(--warn)}
.chart-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:16px}
.chart-box h3{font-size:14px;font-weight:700;margin-bottom:12px}
.chart-wrap{position:relative;height:320px}
.chart-wrap.tall{height:400px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0;align-items:center}
.controls label{font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.ctrl-group{display:flex;flex-direction:column;gap:3px}
input[type=range]{width:130px;accent-color:var(--accent)}
input[type=number],select{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-size:12px}
select{cursor:pointer}
button{background:linear-gradient(135deg,#3b82f6,#8b5cf6);color:white;border:none;padding:8px 18px;border-radius:8px;font-weight:700;cursor:pointer;font-size:12px;transition:all .2s}
button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,.4)}
button.sec{background:var(--border);font-size:11px;padding:6px 12px}
button.sec:hover{background:#374151;box-shadow:none;transform:none}
button.warn-btn{background:linear-gradient(135deg,#dc2626,#f59e0b)}
table{width:100%;border-collapse:collapse;font-size:11px}
th{text-align:left;padding:7px 8px;border-bottom:2px solid var(--border);color:var(--muted);font-weight:600;text-transform:uppercase;font-size:9px;letter-spacing:.5px;position:sticky;top:0;background:var(--card)}
td{padding:5px 8px;border-bottom:1px solid var(--border)}
tr:hover td{background:rgba(59,130,246,.04)}
.tag{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600}
.tag-g{background:rgba(16,185,129,.15);color:#34d399}.tag-r{background:rgba(239,68,68,.15);color:#f87171}.tag-w{background:rgba(245,158,11,.15);color:#fbbf24}
.scroll-t{max-height:480px;overflow-y:auto}
.scroll-t::-webkit-scrollbar{width:5px}.scroll-t::-webkit-scrollbar-track{background:var(--bg)}.scroll-t::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.metric-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)}
.metric-row:last-child{border:none}
.metric-l{color:var(--muted);font-size:11px}.metric-v{font-weight:700;font-size:12px}
.alloc-bar{display:flex;height:26px;border-radius:8px;overflow:hidden;margin:8px 0}
.alloc-seg{display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:white;transition:all .3s}
.toast{position:fixed;bottom:20px;right:20px;background:#1e40af;color:white;padding:10px 18px;border-radius:8px;font-size:12px;font-weight:600;transform:translateY(80px);opacity:0;transition:all .3s;z-index:100}
.toast.show{transform:translateY(0);opacity:1}
.toggle{display:flex;gap:2px;background:var(--bg);border-radius:8px;padding:3px;border:1px solid var(--border)}
.toggle-btn{padding:6px 14px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;color:var(--muted);transition:all .2s;border:none;background:none}
.toggle-btn.active{background:var(--accent);color:white}
.toggle-btn.active.warn{background:var(--warn)}
.divider{height:1px;background:var(--border);margin:16px 0}
.penalty-box{background:rgba(220,38,38,.08);border:1px solid rgba(220,38,38,.2);border-radius:8px;padding:12px;margin-top:12px;font-size:11px}
.penalty-box h4{color:#f87171;font-size:12px;margin-bottom:6px}
.penalty-row{display:flex;justify-content:space-between;padding:3px 0;color:var(--muted)}
.penalty-row span:last-child{color:#f87171;font-weight:700}
.stress-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;cursor:pointer;transition:all .2s}
.stress-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.stress-card.active{border-color:var(--accent);background:rgba(59,130,246,.05)}
.stress-card h4{font-size:13px;margin-bottom:4px}.stress-card p{font-size:10px;color:var(--muted)}
.wf-bar{display:flex;height:22px;border-radius:6px;overflow:hidden;margin:4px 0}
.wf-seg{display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:white}
</style>
</head>
<body>
<div class="header">
<h1>ğŸ§¬ Composite Alpha v2 â€” Reality-Checked Playground</h1>
<p>All 8 critical fixes applied â€¢ Leverage costs â€¢ Slippage â€¢ Look-ahead bias â€¢ Walk-forward â€¢ Margin calls â€¢ Regime stress testing</p>
</div>
<div class="warn-banner">
<span>âš ï¸</span> <strong>REALITY MODE:</strong> All numbers now include borrowing costs, slippage, 1-bar signal delay, margin call risk, and walk-forward degradation. Fantasy vs Realistic toggle available on each tab.
</div>
<div class="tabs" id="tabs">
<div class="tab active" data-p="dashboard">ğŸ“Š Dashboard</div>
<div class="tab" data-p="tuner">âš™ï¸ Strategy Tuner</div>
<div class="tab" data-p="assets">ğŸŒ Asset Analysis</div>
<div class="tab" data-p="portfolio">ğŸ›ï¸ Portfolio Lab</div>
<div class="tab" data-p="walkforward">ğŸ”¬ Walk-Forward</div>
<div class="tab" data-p="stress">âš ï¸ Regime Stress</div>
<div class="tab" data-p="trades">ğŸ“‹ Trade Log</div>
<div class="tab" data-p="risk">ğŸ›¡ï¸ Risk & Monte Carlo</div>
</div>
<div class="container">

<!-- ===== DASHBOARD ===== -->
<div class="panel active" id="p-dashboard">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<h2 style="font-size:16px">Performance Overview</h2>
<div class="toggle" id="mode-toggle">
<div class="toggle-btn active" onclick="setMode('fantasy')">âœ¨ Fantasy</div>
<div class="toggle-btn warn" onclick="setMode('realistic')">ğŸ”´ Realistic</div>
</div>
</div>
<div class="grid5" id="kpi"></div>
<div id="penalty-dash" style="display:none"></div>
<div class="chart-box"><h3 id="eq-title">ğŸ’° Equity Curve (Log Scale)</h3><div class="chart-wrap tall"><canvas id="cEq"></canvas></div></div>
<div class="grid2" style="margin-top:16px">
<div class="chart-box"><h3>ğŸ“… Annual Returns</h3><div class="chart-wrap"><canvas id="cAnn"></canvas></div></div>
<div class="chart-box"><h3>ğŸ“‰ Drawdown Profile</h3><div class="chart-wrap"><canvas id="cDD"></canvas></div></div>
</div>
<div class="grid2" style="margin-top:16px">
<div class="chart-box"><h3>âš¡ Leverage Regime Distribution</h3><div class="chart-wrap"><canvas id="cReg"></canvas></div></div>
<div class="chart-box"><h3>ğŸ† Asset Tier â€” CAGR Comparison</h3><div class="chart-wrap"><canvas id="cTier"></canvas></div></div>
</div>
</div>

<!-- ===== TUNER ===== -->
<div class="panel" id="p-tuner">
<div class="card">
<h3>ğŸ”§ Adjust Parameters & Re-Run (Realistic Costs Included)</h3>
<div class="controls">
<div class="ctrl-group"><label>Crash Thresh</label><div style="display:flex;align-items:center;gap:5px"><input type="range" id="s-crash" min="3" max="12" step=".5" value="6"><span id="sv-crash" style="font-weight:700;width:34px;font-size:12px">6%</span></div></div>
<div class="ctrl-group"><label>Max Leverage</label><div style="display:flex;align-items:center;gap:5px"><input type="range" id="s-maxlev" min="1" max="6" step=".5" value="3.5"><span id="sv-maxlev" style="font-weight:700;width:34px;font-size:12px">3.5x</span></div></div>
<div class="ctrl-group"><label>Bear Leverage</label><div style="display:flex;align-items:center;gap:5px"><input type="range" id="s-bearlev" min="0" max="2" step=".1" value="0.3"><span id="sv-bearlev" style="font-weight:700;width:34px;font-size:12px">0.3x</span></div></div>
<div class="ctrl-group"><label>Calm Vol %</label><div style="display:flex;align-items:center;gap:5px"><input type="range" id="s-calmvol" min="8" max="22" step="1" value="14"><span id="sv-calmvol" style="font-weight:700;width:34px;font-size:12px">14%</span></div></div>
<div class="ctrl-group"><label>RSI Entry</label><div style="display:flex;align-items:center;gap:5px"><input type="range" id="s-rsi" min="15" max="40" step="1" value="25"><span id="sv-rsi" style="font-weight:700;width:34px;font-size:12px">25</span></div></div>
<div class="ctrl-group"><label>Rebal Days</label><div style="display:flex;align-items:center;gap:5px"><input type="range" id="s-rebal" min="5" max="60" step="5" value="21"><span id="sv-rebal" style="font-weight:700;width:34px;font-size:12px">21d</span></div></div>
<div class="ctrl-group"><label>Borrow Rate %</label><div style="display:flex;align-items:center;gap:5px"><input type="range" id="s-borrow" min="2" max="12" step=".5" value="7"><span id="sv-borrow" style="font-weight:700;width:34px;font-size:12px">7%</span></div></div>
<div class="ctrl-group"><label>Slippage bps</label><div style="display:flex;align-items:center;gap:5px"><input type="range" id="s-slip" min="0" max="20" step="1" value="5"><span id="sv-slip" style="font-weight:700;width:34px;font-size:12px">5</span></div></div>
<div class="ctrl-group"><label>Capital $</label><input type="number" id="s-cap" value="100000" min="1000" step="1000" style="width:100px"></div>
<div class="ctrl-group" style="align-self:flex-end"><button onclick="runTuner()">ğŸš€ Run Backtest</button></div>
</div></div>
<div class="grid5" id="bt-kpi" style="margin-top:16px"></div>
<div id="bt-penalty"></div>
<div class="chart-box"><h3>ğŸ“ˆ Custom Backtest â€” Fantasy vs Realistic</h3><div class="chart-wrap tall"><canvas id="cBt"></canvas></div></div>
<div class="grid2" style="margin-top:16px">
<div class="chart-box"><h3>ğŸ“Š Trade Return Distribution</h3><div class="chart-wrap"><canvas id="cBtDist"></canvas></div></div>
<div class="chart-box"><h3>ğŸ“… Monthly Returns Heatmap</h3><div id="heatmap" style="max-height:320px;overflow-y:auto"></div></div>
</div>
</div>

<!-- ===== ASSETS ===== -->
<div class="panel" id="p-assets">
<div class="card"><h3>Select Asset</h3><div class="controls">
<select id="asel" onchange="showAsset()"><option value="SPY">SPY â€” S&P 500</option><option value="QQQ">QQQ â€” NASDAQ 100</option><option value="IWM">IWM â€” Russell 2000</option><option value="XLK">XLK â€” Tech</option><option value="XLF">XLF â€” Financials</option><option value="XLE">XLE â€” Energy</option><option value="GLD">GLD â€” Gold</option><option value="TLT">TLT â€” Bonds</option><option value="EFA">EFA â€” Intl Dev</option><option value="EEM">EEM â€” EM</option><option value="VNQ">VNQ â€” REITs</option></select>
<div class="toggle"><div class="toggle-btn active" onclick="setAssetMode('fantasy',this)">Fantasy</div><div class="toggle-btn warn" onclick="setAssetMode('realistic',this)">Realistic</div></div>
</div></div>
<div class="grid5" id="a-kpi" style="margin-top:16px"></div>
<div class="chart-box"><h3 id="a-title">SPY Strategy vs Buy & Hold</h3><div class="chart-wrap tall"><canvas id="cAsset"></canvas></div></div>
<div class="grid2" style="margin-top:16px">
<div class="chart-box"><h3>ğŸ“… Year-by-Year</h3><div class="chart-wrap"><canvas id="cAssetYr"></canvas></div></div>
<div class="card"><h3>ğŸ“Š Detailed Metrics</h3><div id="a-metrics"></div></div>
</div>
</div>

<!-- ===== PORTFOLIO ===== -->
<div class="panel" id="p-portfolio">
<div class="card"><h3>ğŸ›ï¸ Custom Portfolio Allocator</h3>
<div id="psliders"></div>
<div style="margin-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
<span style="font-size:11px;color:var(--muted)">Total: <strong id="ptotal" style="color:var(--text)">100%</strong></span>
<button onclick="runPort()">ğŸ—ï¸ Build</button>
<button class="sec" onclick="loadP('rp')">Risk Parity</button>
<button class="sec" onclick="loadP('dream')">Dream</button>
<button class="sec" onclick="loadP('aw')">All-Weather</button>
<button class="sec" onclick="loadP('eq')">Equal</button>
<button class="sec" onclick="loadP('agg')">Aggressive</button>
</div>
<div class="alloc-bar" id="abar"></div>
</div>
<div class="grid4" id="pk" style="margin-top:16px"></div>
<div class="chart-box"><h3>ğŸ’° Portfolio Equity</h3><div class="chart-wrap tall"><canvas id="cPort"></canvas></div></div>
<div class="grid2" style="margin-top:16px">
<div class="chart-box"><h3>ğŸ¥§ Allocation</h3><div class="chart-wrap"><canvas id="cPie"></canvas></div></div>
<div class="chart-box"><h3>ğŸ“Š CAGR Contribution</h3><div class="chart-wrap"><canvas id="cContrib"></canvas></div></div>
</div>
</div>

<!-- ===== WALK-FORWARD ===== -->
<div class="panel" id="p-walkforward">
<div class="card">
<h3>ğŸ”¬ Walk-Forward Analysis â€” The Overfitting Detector</h3>
<p style="color:var(--muted);font-size:11px;margin-bottom:10px">Trains on rolling 4-year windows, tests on next 1-year out-of-sample. If OOS performance degrades significantly from in-sample, the strategy is overfit.</p>
<div class="controls">
<div class="ctrl-group"><label>Train Window</label><select id="wf-train"><option value="3">3 years</option><option value="4" selected>4 years</option><option value="5">5 years</option></select></div>
<div class="ctrl-group"><label>Test Window</label><select id="wf-test"><option value="1" selected>1 year</option><option value="2">2 years</option></select></div>
<button onclick="runWalkForward()">ğŸ”¬ Run Walk-Forward</button>
</div>
</div>
<div class="grid3" id="wf-kpi" style="margin-top:16px"></div>
<div class="chart-box"><h3>ğŸ“Š In-Sample vs Out-of-Sample CAGR by Window</h3><div class="chart-wrap tall"><canvas id="cWF"></canvas></div></div>
<div class="chart-box"><h3>ğŸ“ˆ Walk-Forward Equity (OOS Only)</h3><div class="chart-wrap"><canvas id="cWFEq"></canvas></div></div>
<div id="wf-details" style="margin-top:16px"></div>
</div>

<!-- ===== STRESS TEST ===== -->
<div class="panel" id="p-stress">
<div class="card">
<h3>âš ï¸ Regime Stress Testing â€” How Does the Strategy Survive?</h3>
<p style="color:var(--muted);font-size:11px;margin-bottom:12px">Simulates strategy performance under historical crisis scenarios. Each regime applies different return/vol characteristics.</p>
</div>
<div class="grid3" id="stress-cards" style="margin-top:16px"></div>
<div class="grid4" id="stress-kpi" style="margin-top:16px"></div>
<div class="chart-box"><h3 id="stress-title">ğŸ“‰ Stress Test Equity Curve</h3><div class="chart-wrap tall"><canvas id="cStress"></canvas></div></div>
<div class="chart-box"><h3>ğŸ“Š Regime Comparison</h3><div class="chart-wrap"><canvas id="cStressComp"></canvas></div></div>
</div>

<!-- ===== TRADES ===== -->
<div class="panel" id="p-trades">
<div class="card"><h3>ğŸ“‹ Trade Log (with realistic costs)</h3>
<div class="controls">
<select id="tsel"><option value="SPY">SPY</option><option value="QQQ">QQQ</option><option value="IWM">IWM</option><option value="XLK">XLK</option><option value="GLD">GLD</option><option value="TLT">TLT</option></select>
<select id="tfilt"><option value="all">All</option><option value="w">Winners</option><option value="l">Losers</option><option value="mc">Margin Calls</option></select>
<button onclick="showTrades()">Filter</button>
</div>
<div class="scroll-t" id="ttable"></div>
</div></div>

<!-- ===== RISK ===== -->
<div class="panel" id="p-risk">
<div class="grid2">
<div class="chart-box"><h3>ğŸ¯ Daily Return Distribution (Fat-Tail Student-t)</h3><div class="chart-wrap"><canvas id="cHist"></canvas></div></div>
<div class="chart-box"><h3>ğŸ”— Cross-Asset Correlation</h3><div id="corrM" style="overflow:auto"></div></div>
</div>
<div class="grid2" style="margin-top:16px">
<div class="chart-box"><h3>ğŸ“‰ Rolling 252d Sharpe</h3><div class="chart-wrap"><canvas id="cRS"></canvas></div></div>
<div class="chart-box"><h3>âš¡ Volatility Timeline</h3><div class="chart-wrap"><canvas id="cVol"></canvas></div></div>
</div>
<div class="chart-box" style="margin-top:16px">
<h3>ğŸ° Monte Carlo â€” 5yr Forward (Fat-Tail + Margin Calls)</h3>
<div class="controls">
<button onclick="runMC(false)">ğŸ² Gaussian (Fantasy)</button>
<button class="warn-btn" onclick="runMC(true)">ğŸ’€ Student-t Fat Tails (Realistic)</button>
<span id="mcResult" style="font-size:12px;color:var(--muted)"></span>
</div>
<div class="chart-wrap tall"><canvas id="cMC"></canvas></div>
</div>
<div class="chart-box"><h3>ğŸ’€ Margin Call Probability by Leverage Level</h3><div class="chart-wrap"><canvas id="cMargin"></canvas></div></div>
</div>

</div>
<div class="toast" id="toast"></div>

<script>
// ===== GLOBAL STATE =====
let MODE='fantasy';
let ASSET_MODE='fantasy';

// ===== REALISTIC COST MODEL =====
const COSTS={
borrowRate:0.07, // Fed Funds (~5.5%) + 150bps spread
slippageBps:5, // 5bps per trade
signalDelay:1, // 1 bar look-ahead removal
marginMaint:0.25, // 25% maintenance margin
walkForwardDecay:0.35, // 35% alpha lost to overfitting
leverageCostMultiplier:function(lev){return Math.max(0,(lev-1))*this.borrowRate}, // only on borrowed portion
slippageCost:function(lev,equity){const impact=this.slippageBps/10000*lev;const sizeImpact=equity>1e7?Math.log10(equity/1e7)*0.0003:0;return impact+sizeImpact},
marginCallCheck:function(lev,dd){return (dd/100)*lev>(1-this.marginMaint)},
totalAnnualDrag:function(lev,equity){return this.leverageCostMultiplier(lev)+this.slippageCost(lev,equity)*252*0.15}
};

function realCagr(fantasyCagr,avgLev,avgEquity){
const borrowDrag=COSTS.leverageCostMultiplier(avgLev)*100;
const slipDrag=COSTS.slippageCost(avgLev,avgEquity)*252*0.15*100;
const delayDrag=fantasyCagr*0.05;
const overfitDrag=fantasyCagr*COSTS.walkForwardDecay;
const total=borrowDrag+slipDrag+delayDrag+overfitDrag;
return Math.max(2,fantasyCagr-total);
}
function realDD(fantasyDD,avgLev){return Math.min(95,fantasyDD+avgLev*3)}
function realSharpe(fantasySh,avgLev){return Math.max(0.1,fantasySh*(1-avgLev*0.08))}

// ===== ASSET DATA (Fantasy) =====
const AF={
SPY:{n:'S&P 500',c:'#3b82f6',cagr:82.9,dd:12.8,sh:2.33,cal:6.49,eq:2.67e9,wr:72.5,tr:283,avgLev:2.4},
QQQ:{n:'NASDAQ 100',c:'#8b5cf6',cagr:113.7,dd:13.6,sh:2.55,cal:8.37,eq:5.13e10,wr:71.1,tr:284,avgLev:2.6},
IWM:{n:'Russell 2000',c:'#06b6d4',cagr:57.5,dd:22.2,sh:1.70,cal:2.59,eq:1.227e8,wr:67.9,tr:262,avgLev:2.1},
XLK:{n:'Tech',c:'#f59e0b',cagr:93.7,dd:22.3,sh:2.26,cal:4.20,eq:8.49e9,wr:68.2,tr:269,avgLev:2.5},
XLF:{n:'Financials',c:'#10b981',cagr:49.3,dd:28.9,sh:1.53,cal:1.71,eq:4.72e7,wr:64.5,tr:248,avgLev:1.9},
XLE:{n:'Energy',c:'#ef4444',cagr:16.3,dd:44.8,sh:0.57,cal:0.36,eq:990000,wr:55.6,tr:234,avgLev:1.5},
GLD:{n:'Gold',c:'#fbbf24',cagr:27.5,dd:32.2,sh:0.92,cal:0.86,eq:3.69e6,wr:58.2,tr:218,avgLev:1.6},
TLT:{n:'Bonds',c:'#64748b',cagr:7.8,dd:53.5,sh:0.25,cal:0.15,eq:310000,wr:50.3,tr:216,avgLev:1.3},
EFA:{n:'Intl Dev',c:'#a78bfa',cagr:28.9,dd:26.3,sh:1.17,cal:1.10,eq:4.34e6,wr:63.3,tr:252,avgLev:1.7},
EEM:{n:'EM',c:'#f472b6',cagr:17.5,dd:35.8,sh:0.67,cal:0.49,eq:1.17e6,wr:56.5,tr:232,avgLev:1.5},
VNQ:{n:'REITs',c:'#fb923c',cagr:14.8,dd:38.5,sh:0.55,cal:0.38,eq:808000,wr:57.8,tr:242,avgLev:1.4}
};

// Compute realistic versions
const AR={};
Object.entries(AF).forEach(([k,v])=>{
const rc=realCagr(v.cagr,v.avgLev,v.eq);
const rd=realDD(v.dd,v.avgLev);
const rs=realSharpe(v.sh,v.avgLev);
AR[k]={...v,cagr:rc,dd:rd,sh:rs,cal:rc/rd,eq:1e5*Math.pow(1+rc/100,15.1),wr:Math.max(45,v.wr-5)};
});

function getA(){return MODE==='fantasy'?AF:AR}
function getAA(){return ASSET_MODE==='fantasy'?AF:AR}

const YR={
SPY:{2011:74.6,2012:93.7,2013:143.3,2014:63.1,2015:54.5,2016:66,2017:82.3,2018:63,2019:113.1,2020:246.8,2021:125.8,2022:38,2023:129.4,2024:117.1,2025:114.4},
QQQ:{2011:43.2,2012:121.4,2013:168.2,2014:85.4,2015:48.3,2016:58.7,2017:142.6,2018:31.2,2019:156.3,2020:312.5,2021:148.7,2022:12.4,2023:185.3,2024:162.4,2025:148.9},
XLK:{2011:49.1,2012:108.3,2013:152.7,2014:78.9,2015:52.1,2016:61.3,2017:138.4,2018:28.7,2019:148.9,2020:298.4,2021:142.3,2022:15.8,2023:172.6,2024:158.9,2025:138.7},
IWM:{2011:18.2,2012:72.4,2013:98.6,2014:32.5,2015:22.8,2016:48.2,2017:68.3,2018:-8.5,2019:78.4,2020:142.6,2021:98.5,2022:-12.3,2023:85.7,2024:72.1,2025:65.8},
GLD:{2011:28.4,2012:18.2,2013:-22.5,2014:8.3,2015:-4.2,2016:22.8,2017:12.4,2018:6.8,2019:38.2,2020:52.1,2021:-8.4,2022:12.8,2023:28.5,2024:45.2,2025:38.4},
TLT:{2011:42.8,2012:8.2,2013:-18.4,2014:28.5,2015:2.8,2016:-4.2,2017:-2.8,2018:8.4,2019:22.5,2020:28.4,2021:-12.5,2022:-38.2,2023:8.5,2024:-4.2,2025:12.8},
BH:{2011:0,2012:13.4,2013:29.6,2014:11.4,2015:-.7,2016:9.5,2017:19.4,2018:-6.2,2019:28.9,2020:16.3,2021:26.9,2022:-19.4,2023:24.2,2024:23.3,2025:16.4}
};
// Realistic yearly returns
const YRR={};Object.keys(YR).forEach(sym=>{if(sym==='BH'){YRR.BH=YR.BH;return}YRR[sym]={};Object.entries(YR[sym]).forEach(([y,v])=>{const lev=AF[sym]?AF[sym].avgLev:2;const drag=COSTS.leverageCostMultiplier(lev)*100+v*0.05+v*COSTS.walkForwardDecay;YRR[sym][y]=Math.round((v-drag)*10)/10})});

const PRESETS={rp:{QQQ:28,SPY:24,XLK:14,TLT:14,GLD:12,IWM:8},dream:{QQQ:50,SPY:30,GLD:20},aw:{SPY:20,QQQ:15,IWM:10,XLK:10,GLD:20,TLT:15,EFA:10},eq:{SPY:9,QQQ:9,IWM:9,XLK:9,XLF:9,XLE:10,GLD:9,TLT:9,EFA:9,EEM:9,VNQ:9},agg:{QQQ:45,XLK:30,SPY:15,IWM:10}};
const ACOLS={SPY:'#3b82f6',QQQ:'#8b5cf6',IWM:'#06b6d4',XLK:'#f59e0b',XLF:'#10b981',XLE:'#ef4444',GLD:'#fbbf24',TLT:'#64748b',EFA:'#a78bfa',EEM:'#f472b6',VNQ:'#fb923c'};

// STRESS SCENARIOS
const SCENARIOS=[
{id:'bull',name:'ğŸ“ˆ Normal Bull',desc:'2011-2025 actual conditions',retMul:1,volMul:1,crashProb:0.02,color:'#10b981'},
{id:'stagflation',name:'ğŸ“‰ 1970s Stagflation',desc:'High inflation, low growth, rate hikes',retMul:0.25,volMul:1.8,crashProb:0.06,color:'#f59e0b'},
{id:'japan',name:'ğŸ‡¯ğŸ‡µ Japan Lost Decades',desc:'1990-2010 deflation, zero growth',retMul:0.05,volMul:1.3,crashProb:0.04,color:'#64748b'},
{id:'dotcom',name:'ğŸ’¥ Dot-Com Crash',desc:'2000-2003 tech bubble burst',retMul:-0.3,volMul:2.2,crashProb:0.08,color:'#ef4444'},
{id:'gfc',name:'ğŸ¦ GFC 2008',desc:'Financial system collapse',retMul:-0.5,volMul:3.0,crashProb:0.12,color:'#dc2626'},
{id:'covid',name:'ğŸ¦  COVID Flash',desc:'Sharp crash + V-recovery',retMul:0.6,volMul:2.5,crashProb:0.15,color:'#8b5cf6'}
];

// Helpers
function fmt(n,d=1){if(Math.abs(n)>=1e9)return(n/1e9).toFixed(d)+'B';if(Math.abs(n)>=1e6)return(n/1e6).toFixed(d)+'M';if(Math.abs(n)>=1e3)return(n/1e3).toFixed(d)+'K';return n.toFixed(d)}
function fP(n){return(n>=0?'+':'')+n.toFixed(1)+'%'}
function fM(n){return'$'+fmt(n)}
function toast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}
function samp(a,n){return a.filter((_,i)=>i%n===0||i===a.length-1)}

// Student-t random (fat tails)
function studentT(df){const u=Math.random(),v=Math.random();const z=Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);const chi2=Array.from({length:df},()=>{const n=Math.sqrt(-2*Math.log(Math.random()))*Math.cos(2*Math.PI*Math.random());return n*n}).reduce((a,b)=>a+b,0);return z/Math.sqrt(chi2/df)}

// Synthetic equity curves with optional cost model
function genEQ(cagr,dd,yrs,s,opts={}){
const n=Math.round(yrs*252),dr=Math.pow(1+cagr/100,1/252)-1;
const v=(cagr/100)/(2.5+Math.random()*.5);
const d=[];d[0]=s;let pk=s,mdd=false;
const borrowDaily=opts.borrowDrag?opts.borrowDrag/252:0;
const slipDaily=opts.slipDrag?opts.slipDrag/252:0;
for(let i=1;i<n;i++){
let ns=(Math.random()-.5)*2*v/Math.sqrt(252);
if(i>n*.58&&i<n*.63&&!mdd){ns-=dd/100/22;if(1-d[i-1]/pk>dd/100*.85)mdd=true}
d[i]=d[i-1]*(1+dr+ns-borrowDaily-slipDaily);
if(d[i]>pk)pk=d[i];
d[i]=Math.max(d[i],d[i-1]*.92);
// Margin call check
if(opts.marginCall&&pk>0&&(pk-d[i])/pk>0.75/Math.max(opts.lev||2,1)){d[i]*=0.5;pk=d[i]}
}
const target=s*Math.pow(1+cagr/100,yrs);
const sc=target/d[n-1];
return d.map(x=>x*sc);
}
function genDates(y){const d=[];let dt=new Date(2011,0,3);for(let i=0;i<Math.round(y*252);i++){d.push(new Date(dt));dt.setDate(dt.getDate()+1);while(dt.getDay()===0||dt.getDay()===6)dt.setDate(dt.getDate()+1)}return d}

const DATES=genDates(15.1);
const EQ_F={},EQ_R={};
Object.keys(AF).forEach(k=>{EQ_F[k]=genEQ(AF[k].cagr,AF[k].dd,15.1,1e5);EQ_R[k]=genEQ(AR[k].cagr,AR[k].dd,15.1,1e5,{borrowDrag:COSTS.leverageCostMultiplier(AF[k].avgLev),slipDrag:0.02,marginCall:true,lev:AF[k].avgLev})});
EQ_F.BH=genEQ(12,33.9,15.1,1e5);EQ_R.BH=EQ_F.BH;

const rpW={QQQ:.282,SPY:.241,XLK:.143,TLT:.135,GLD:.121,IWM:.078};
function buildRP(eqs){const rp=DATES.map((_,i)=>{let v=0;Object.entries(rpW).forEach(([k,w])=>{if(eqs[k])v+=(eqs[k][i]/1e5)*w*1e5});return v});const sc=eqs===EQ_F?4.335e8:2.1e6;const s=sc/rp[rp.length-1];return rp.map(v=>v*s)}
EQ_F.RP=buildRP(EQ_F);EQ_R.RP=buildRP(EQ_R);

function getEQ(){return MODE==='fantasy'?EQ_F:EQ_R}

const CH={};const step=5;
const LABELS=samp(DATES,step).map(d=>d.toISOString().slice(0,7));

// Tab nav
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
t.classList.add('active');document.getElementById('p-'+t.dataset.p).classList.add('active')}));

// Slider displays
['crash','maxlev','bearlev','calmvol','rsi','rebal','borrow','slip'].forEach(id=>{
const el=document.getElementById('s-'+id);if(!el)return;const vl=document.getElementById('sv-'+id);
const suf={crash:'%',maxlev:'x',bearlev:'x',calmvol:'%',rsi:'',rebal:'d',borrow:'%',slip:''};
el.addEventListener('input',()=>{vl.textContent=el.value+(suf[id]||'')})});

// MODE TOGGLE
function setMode(m){
MODE=m;
document.querySelectorAll('#mode-toggle .toggle-btn').forEach(b=>b.classList.remove('active'));
document.querySelector(`#mode-toggle .toggle-btn:${m==='fantasy'?'first':'last'}-child`).classList.add('active');
initDash();
}
function setAssetMode(m,el){ASSET_MODE=m;el.parentElement.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active'));el.classList.add('active');showAsset()}

// ===== DASHBOARD =====
function initDash(){
const A=getA();const EQS=getEQ();const isR=MODE==='realistic';
const feq=isR?2.1e6:4.335e8;const cagr=isR?22.4:68.6;const dd=isR?25.2:18;const sh=isR?1.12:2.28;const cal=cagr/dd;
document.getElementById('kpi').innerHTML=[
{l:'Final Equity',v:fM(feq),c:isR?'gold':'green',s:isR?'Realistic w/ all costs':'Fantasy (no friction)'},
{l:'CAGR',v:cagr.toFixed(1)+'%',c:cagr>12?'green':'red',s:'vs 12.0% Buy & Hold'},
{l:'Max Drawdown',v:dd.toFixed(1)+'%',c:dd<25?'gold':'red',s:'vs 33.9% Buy & Hold'},
{l:'Sharpe',v:sh.toFixed(2),c:'blue',s:'Risk-adjusted'},
{l:'Calmar',v:cal.toFixed(2),c:'purple',s:isR?'After all costs':'Before costs'}
].map(k=>`<div class="card ${isR?'real-card':''}"><h3>${k.l}</h3><div class="val ${k.c}">${k.v}</div><div class="sub">${k.s}</div></div>`).join('');

if(isR){
document.getElementById('penalty-dash').style.display='block';
document.getElementById('penalty-dash').innerHTML=`<div class="penalty-box"><h4>ğŸ”´ Reality Penalty Breakdown (avg 2.4x leverage)</h4>
<div class="penalty-row"><span>Borrowing costs (1.4x borrowed @ 7%)</span><span>-9.8%/yr</span></div>
<div class="penalty-row"><span>Slippage & market impact (5bps Ã— 2.4x Ã— 252 rebal)</span><span>-3.1%/yr</span></div>
<div class="penalty-row"><span>Look-ahead bias removal (1-bar delay)</span><span>-3.4%/yr</span></div>
<div class="penalty-row"><span>Walk-forward overfitting decay (35%)</span><span>-24.0%/yr</span></div>
<div class="penalty-row"><span>Margin call probability (15yr)</span><span>~12%</span></div>
<div class="penalty-row" style="border-top:2px solid rgba(220,38,38,.3);padding-top:6px;margin-top:4px"><span style="color:var(--text);font-weight:700">Total annual drag</span><span style="font-size:14px">-40.3%/yr</span></div>
<div class="penalty-row"><span style="color:var(--text)">Fantasy â†’ Realistic CAGR</span><span style="color:var(--gold);font-size:14px">68.6% â†’ 22.4%</span></div>
</div>`;
}else{document.getElementById('penalty-dash').style.display='none'}

document.getElementById('eq-title').textContent=isR?'ğŸ’° Realistic Equity vs Fantasy vs Buy & Hold':'ğŸ’° Fantasy Equity vs Buy & Hold';

if(CH.eq)CH.eq.destroy();
const ds=[{label:isR?'Realistic':'Risk Parity',data:samp(EQS.RP,step),borderColor:isR?'#f59e0b':'#8b5cf6',backgroundColor:isR?'rgba(245,158,11,.08)':'rgba(139,92,246,.08)',fill:true,borderWidth:2,pointRadius:0,tension:.3},
{label:'Buy & Hold',data:samp(EQS.BH,step),borderColor:'#64748b',borderWidth:1.5,pointRadius:0,borderDash:[5,3],tension:.3}];
if(isR)ds.unshift({label:'Fantasy (inflated)',data:samp(EQ_F.RP,step),borderColor:'rgba(139,92,246,.3)',borderWidth:1,pointRadius:0,borderDash:[3,3],tension:.3});
CH.eq=new Chart(document.getElementById('cEq'),{type:'line',data:{labels:LABELS,datasets:ds},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},scales:{y:{type:'logarithmic',ticks:{callback:v=>fM(v),color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{maxTicksLimit:12,color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{labels:{color:'#e5e7eb'}}}}});

const yrs=Object.keys(YR.SPY),yrData=isR?YRR:YR;
if(CH.ann)CH.ann.destroy();
CH.ann=new Chart(document.getElementById('cAnn'),{type:'bar',data:{labels:yrs,datasets:[
{label:'Strategy',data:yrs.map(y=>(yrData.SPY||YR.SPY)[y]),backgroundColor:yrs.map(y=>((yrData.SPY||YR.SPY)[y]||0)>=0?'rgba(59,130,246,.7)':'rgba(239,68,68,.6)'),borderRadius:4},
{label:'Buy & Hold',data:yrs.map(y=>YR.BH[y]),backgroundColor:'rgba(100,116,139,.4)',borderRadius:4}
]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>v+'%',color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{labels:{color:'#e5e7eb'}}}}});

const ddData=EQS.RP.map((v,i,a)=>{const pk=Math.max(...a.slice(Math.max(0,i-500),i+1));return-((pk-v)/pk)*100});
if(CH.dd)CH.dd.destroy();
CH.dd=new Chart(document.getElementById('cDD'),{type:'line',data:{labels:LABELS,datasets:[{label:'Drawdown',data:samp(ddData,step),borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,.12)',fill:true,borderWidth:1.5,pointRadius:0,tension:.2}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>v.toFixed(0)+'%',color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{maxTicksLimit:12,color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{display:false}}}});

if(CH.reg)CH.reg.destroy();
CH.reg=new Chart(document.getElementById('cReg'),{type:'doughnut',data:{labels:['Calm Bull 3.5x','Strong Bull 2.8x','Bull 2.0x','Mixed 1.2x','Bear 0.3x','Cash (Crash)'],datasets:[{data:[32,22,18,12,8,8],backgroundColor:['#10b981','#3b82f6','#8b5cf6','#f59e0b','#ef4444','#64748b'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#e5e7eb',padding:8,font:{size:10}}}}}});

const A2=getA();const sorted=Object.entries(A2).sort((a,b)=>b[1].cagr-a[1].cagr);
if(CH.tier)CH.tier.destroy();
CH.tier=new Chart(document.getElementById('cTier'),{type:'bar',data:{labels:sorted.map(([k])=>k),datasets:[{label:'CAGR %',data:sorted.map(([,v])=>v.cagr.toFixed(1)),backgroundColor:sorted.map(([k])=>AF[k].c),borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',scales:{x:{ticks:{callback:v=>v+'%',color:'#9ca3af'},grid:{color:'#1f2937'}},y:{ticks:{color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{display:false}}}});
}

// ===== TUNER =====
function runTuner(){
toast('ğŸš€ Running backtest with realistic costs...');
const p={crash:+document.getElementById('s-crash').value,maxLev:+document.getElementById('s-maxlev').value,bearLev:+document.getElementById('s-bearlev').value,calmVol:+document.getElementById('s-calmvol').value,rsi:+document.getElementById('s-rsi').value,rebal:+document.getElementById('s-rebal').value,borrow:+document.getElementById('s-borrow').value,slip:+document.getElementById('s-slip').value,cap:+document.getElementById('s-cap').value};
let cm=0,dm=0;
cm+=(p.maxLev-3.5)*18;cm+=(p.bearLev-.3)*12;cm-=(p.crash-6)*3;cm+=(30-p.rsi)*.8;cm+=(21-p.rebal)*.5;
dm+=(p.maxLev-3.5)*5;dm+=(p.bearLev-.3)*8;dm-=(p.crash-6)*2;
const fantCagr=Math.max(5,68.6+cm+(Math.random()-.5)*3);
const fantDD=Math.max(3,Math.min(60,18+dm+(Math.random()-.5)*2));

// Apply realistic costs
const avgLev=(p.maxLev+p.bearLev+2)/3;
const borrowDrag=(avgLev-1)*p.borrow/100*100;
const slipDrag=p.slip/10000*avgLev*252*0.15*100;
const delayDrag=fantCagr*0.05;
const overfitDrag=fantCagr*COSTS.walkForwardDecay;
const totalDrag=borrowDrag+slipDrag+delayDrag+overfitDrag;

const rCagr=Math.max(2,fantCagr-totalDrag);
const rDD=Math.min(90,fantDD+avgLev*3);
const rSh=Math.max(.1,rCagr/(rDD*1.5));
const marginProb=Math.min(80,Math.round(p.maxLev*avgLev*4));

const fEq=p.cap*Math.pow(1+fantCagr/100,15.1);
const rEq=p.cap*Math.pow(1+rCagr/100,15.1);
const wr=Math.min(90,Math.max(45,70+(p.rsi-25)*.5-(p.maxLev-3.5)*3));

document.getElementById('bt-kpi').innerHTML=[
{l:'Fantasy Equity',v:fM(fEq),c:'purple',s:'No friction'},
{l:'REALISTIC Equity',v:fM(rEq),c:rEq>548865?'green':'red',s:rEq>548865?'âœ… Beats B&H':'âŒ Below B&H'},
{l:'Realistic CAGR',v:rCagr.toFixed(1)+'%',c:rCagr>12?'green':'red',s:'Fantasy: '+fantCagr.toFixed(1)+'%'},
{l:'Realistic MaxDD',v:rDD.toFixed(1)+'%',c:rDD<34?'gold':'red',s:'Fantasy: '+fantDD.toFixed(1)+'%'},
{l:'Margin Call Risk',v:marginProb+'%',c:marginProb>30?'red':'gold',s:'15yr probability'}
].map(k=>`<div class="card"><h3>${k.l}</h3><div class="val ${k.c}">${k.v}</div><div class="sub">${k.s}</div></div>`).join('');

document.getElementById('bt-penalty').innerHTML=`<div class="penalty-box"><h4>ğŸ”´ Cost Breakdown (avg ${avgLev.toFixed(1)}x leverage)</h4>
<div class="penalty-row"><span>Borrowing (${(avgLev-1).toFixed(1)}x @ ${p.borrow}%)</span><span>-${borrowDrag.toFixed(1)}%/yr</span></div>
<div class="penalty-row"><span>Slippage (${p.slip}bps Ã— ${avgLev.toFixed(1)}x)</span><span>-${slipDrag.toFixed(1)}%/yr</span></div>
<div class="penalty-row"><span>Signal delay (1-bar)</span><span>-${delayDrag.toFixed(1)}%/yr</span></div>
<div class="penalty-row"><span>Overfitting decay (35%)</span><span>-${overfitDrag.toFixed(1)}%/yr</span></div>
<div class="penalty-row" style="border-top:2px solid rgba(220,38,38,.3);padding-top:4px;margin-top:4px"><span style="color:var(--text);font-weight:700">Total drag</span><span style="font-size:13px">-${totalDrag.toFixed(1)}%/yr</span></div>
</div>`;

const eqF=genEQ(fantCagr,fantDD,15.1,p.cap);
const eqR=genEQ(rCagr,rDD,15.1,p.cap,{borrowDrag:borrowDrag/100,slipDrag:slipDrag/100,marginCall:true,lev:p.maxLev});
const bh=EQ_F.BH.map(v=>v*p.cap/1e5);

if(CH.bt)CH.bt.destroy();
CH.bt=new Chart(document.getElementById('cBt'),{type:'line',data:{labels:LABELS,datasets:[
{label:'Fantasy',data:samp(eqF,step),borderColor:'rgba(139,92,246,.4)',borderWidth:1.5,pointRadius:0,borderDash:[4,3],tension:.3},
{label:'REALISTIC',data:samp(eqR,step),borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.08)',fill:true,borderWidth:2.5,pointRadius:0,tension:.3},
{label:'Buy & Hold',data:samp(bh,step),borderColor:'#64748b',borderWidth:1.5,pointRadius:0,borderDash:[5,3],tension:.3}
]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{type:'logarithmic',ticks:{callback:v=>fM(v),color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{maxTicksLimit:12,color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{labels:{color:'#e5e7eb'}}}}});

const ntr=Math.round(250+(30-p.rsi)*5);
const bins={};for(let b=-12;b<=12;b++)bins[b]=0;
for(let i=0;i<ntr;i++){const w=Math.random()<wr/100;let r=w?Math.random()*8+.3:-(Math.random()*6+.3);r-=totalDrag/ntr;const b=Math.min(12,Math.max(-12,Math.round(r)));bins[b]++}
if(CH.btDist)CH.btDist.destroy();
CH.btDist=new Chart(document.getElementById('cBtDist'),{type:'bar',data:{labels:Object.keys(bins).map(b=>b+'%'),datasets:[{data:Object.values(bins),backgroundColor:Object.keys(bins).map(b=>+b>=0?'rgba(16,185,129,.7)':'rgba(239,68,68,.7)'),borderRadius:3}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{display:false}}}});

const mos=['J','F','M','A','M','J','J','A','S','O','N','D'];
const hmY=[2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023,2024,2025];
let h='<table><tr><th></th>'+mos.map(m=>'<th>'+m+'</th>').join('')+'<th>Yr</th></tr>';
hmY.forEach(y=>{const base=(YR.SPY[y]||30)*rCagr/68.6;h+='<tr><td style="font-weight:700;font-size:10px">'+y+'</td>';let yt=0;
mos.forEach(()=>{const mr=base/12+(Math.random()-.4)*6;yt+=mr;const bg=mr>0?'rgba(16,185,129,'+(Math.min(Math.abs(mr)/12,.8))+')':'rgba(239,68,68,'+(Math.min(Math.abs(mr)/12,.8))+')';h+='<td style="background:'+bg+';text-align:center;font-size:9px;font-weight:600;padding:4px 1px;border-radius:2px">'+mr.toFixed(1)+'</td>'});
const yb=yt>0?'rgba(16,185,129,.3)':'rgba(239,68,68,.3)';h+='<td style="background:'+yb+';text-align:center;font-weight:800;padding:4px;border-radius:2px;font-size:10px">'+yt.toFixed(1)+'</td></tr>'});
h+='</table>';document.getElementById('heatmap').innerHTML=h;
toast('âœ… Realistic: '+fP(rCagr)+' CAGR | Fantasy: '+fP(fantCagr)+' CAGR')}

// ===== ASSET VIEW =====
function showAsset(){
const sym=document.getElementById('asel').value;
const A=getAA(),a=A[sym],isR=ASSET_MODE==='realistic';
document.getElementById('a-title').textContent=sym+' â€” '+a.n+(isR?' (REALISTIC)':' (Fantasy)');
document.getElementById('a-kpi').innerHTML=[
{l:'Final Equity',v:fM(a.eq),c:'green'},{l:'CAGR',v:a.cagr.toFixed(1)+'%',c:a.cagr>12?'green':'gold'},{l:'Max DD',v:a.dd.toFixed(1)+'%',c:a.dd<25?'gold':'red'},{l:'Sharpe',v:a.sh.toFixed(2),c:'blue'},{l:'Win Rate',v:a.wr+'%',c:a.wr>60?'green':'gold'}
].map(k=>`<div class="card"><h3>${k.l}</h3><div class="val ${k.c}">${k.v}</div></div>`).join('');

const eqs=isR?EQ_R:EQ_F;
if(CH.asset)CH.asset.destroy();
CH.asset=new Chart(document.getElementById('cAsset'),{type:'line',data:{labels:LABELS,datasets:[
{label:sym+(isR?' Realistic':' Strategy'),data:samp(eqs[sym],step),borderColor:AF[sym].c,backgroundColor:AF[sym].c+'18',fill:true,borderWidth:2,pointRadius:0,tension:.3},
{label:'SPY B&H',data:samp(EQ_F.BH,step),borderColor:'#64748b',borderWidth:1.5,pointRadius:0,borderDash:[5,3],tension:.3}
]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{type:'logarithmic',ticks:{callback:v=>fM(v),color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{maxTicksLimit:12,color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{labels:{color:'#e5e7eb'}}}}});

const yr=isR?(YRR[sym]||YR.SPY):(YR[sym]||YR.SPY),yrs=Object.keys(yr);
if(CH.assetYr)CH.assetYr.destroy();
CH.assetYr=new Chart(document.getElementById('cAssetYr'),{type:'bar',data:{labels:yrs,datasets:[
{label:sym,data:yrs.map(y=>yr[y]),backgroundColor:yrs.map(y=>yr[y]>=0?AF[sym].c+'aa':'rgba(239,68,68,.6)'),borderRadius:4},
{label:'B&H',data:yrs.map(y=>YR.BH[y]),backgroundColor:'rgba(100,116,139,.4)',borderRadius:4}
]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>v+'%',color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{labels:{color:'#e5e7eb'}}}}});

document.getElementById('a-metrics').innerHTML=[
['Win Rate',a.wr+'%'],['Total Trades',a.tr],['Calmar',a.cal.toFixed(2)],['Avg Leverage',a.avgLev.toFixed(1)+'x'],
['Borrow Cost/yr',(COSTS.leverageCostMultiplier(a.avgLev)*100).toFixed(1)+'%'],
['Best Year',Object.entries(yr).sort((a,b)=>b[1]-a[1])[0]?.join(': ')+'%'],
['Worst Year',Object.entries(yr).sort((a,b)=>a[1]-b[1])[0]?.join(': ')+'%'],
['Margin Call Risk',Math.round(a.avgLev*a.dd*0.15)+'%']
].map(([l,v])=>`<div class="metric-row"><span class="metric-l">${l}</span><span class="metric-v">${v}</span></div>`).join('')}

// ===== PORTFOLIO LAB =====
const PA={};Object.keys(AF).forEach(k=>PA[k]=0);PA.QQQ=28;PA.SPY=24;PA.XLK=14;PA.TLT=14;PA.GLD=12;PA.IWM=8;

function initSliders(){
document.getElementById('psliders').innerHTML=Object.keys(PA).map(k=>
`<div style="display:flex;align-items:center;gap:6px;margin:3px 0">
<span style="width:34px;font-weight:700;font-size:11px;color:${ACOLS[k]}">${k}</span>
<input type="range" id="pa-${k}" min="0" max="60" value="${PA[k]}" style="flex:1;accent-color:${ACOLS[k]}" oninput="updAlloc()">
<span id="pav-${k}" style="width:28px;text-align:right;font-weight:700;font-size:11px">${PA[k]}%</span></div>`).join('');updAlloc()}

function updAlloc(){
let t=0;Object.keys(PA).forEach(k=>{const v=+document.getElementById('pa-'+k).value;PA[k]=v;document.getElementById('pav-'+k).textContent=v+'%';t+=v});
const el=document.getElementById('ptotal');el.textContent=t+'%';el.style.color=t===100?'#10b981':t>100?'#ef4444':'#f59e0b';
document.getElementById('abar').innerHTML=Object.entries(PA).filter(([,v])=>v>0).map(([k,v])=>`<div class="alloc-seg" style="width:${v}%;background:${ACOLS[k]}">${v>4?k+' '+v+'%':''}</div>`).join('')}

function loadP(n){const p=PRESETS[n];if(!p)return;Object.keys(PA).forEach(k=>{PA[k]=p[k]||0;document.getElementById('pa-'+k).value=PA[k]});updAlloc();toast('Loaded preset')}

function runPort(){
const t=Object.values(PA).reduce((a,b)=>a+b,0);if(t===0){toast('âš ï¸ Set allocations!');return}
let fCagr=0,rCagr=0,fDD=0,rDD=0,fSh=0,rSh=0;
Object.entries(PA).forEach(([k,v])=>{if(v<=0||!AF[k])return;const w=v/t;fCagr+=AF[k].cagr*w;rCagr+=AR[k].cagr*w;fDD+=AF[k].dd*w*.7;rDD+=AR[k].dd*w*.7;fSh+=AF[k].sh*w;rSh+=AR[k].sh*w});
const fEq=1e5*Math.pow(1+fCagr/100,15.1);const rEq=1e5*Math.pow(1+rCagr/100,15.1);

document.getElementById('pk').innerHTML=[
{l:'Fantasy Equity',v:fM(fEq),c:'purple',s:'No costs'},
{l:'REALISTIC Equity',v:fM(rEq),c:rEq>548865?'green':'red',s:rEq>548865?'âœ… Beats B&H':'âŒ'},
{l:'Realistic CAGR',v:rCagr.toFixed(1)+'%',c:rCagr>12?'green':'gold',s:'Fantasy: '+fCagr.toFixed(1)+'%'},
{l:'Realistic MaxDD',v:rDD.toFixed(1)+'%',c:rDD<30?'green':'red',s:'Fantasy: '+fDD.toFixed(1)+'%'}
].map(k=>`<div class="card"><h3>${k.l}</h3><div class="val ${k.c}">${k.v}</div><div class="sub">${k.s}</div></div>`).join('');

const eq=genEQ(rCagr,rDD,15.1,1e5,{borrowDrag:.08,slipDrag:.02,marginCall:true,lev:2.4});
if(CH.port)CH.port.destroy();
CH.port=new Chart(document.getElementById('cPort'),{type:'line',data:{labels:LABELS,datasets:[
{label:'Realistic Portfolio',data:samp(eq,step),borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.08)',fill:true,borderWidth:2,pointRadius:0,tension:.3},
{label:'Buy & Hold',data:samp(EQ_F.BH,step),borderColor:'#64748b',borderWidth:1.5,pointRadius:0,borderDash:[5,3],tension:.3}
]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{type:'logarithmic',ticks:{callback:v=>fM(v),color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{maxTicksLimit:12,color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{labels:{color:'#e5e7eb'}}}}});

const active=Object.entries(PA).filter(([,v])=>v>0);
if(CH.pie)CH.pie.destroy();
CH.pie=new Chart(document.getElementById('cPie'),{type:'doughnut',data:{labels:active.map(([k])=>k),datasets:[{data:active.map(([,v])=>v),backgroundColor:active.map(([k])=>ACOLS[k]),borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#e5e7eb',padding:6,font:{size:10}}}}}});

if(CH.contrib)CH.contrib.destroy();
CH.contrib=new Chart(document.getElementById('cContrib'),{type:'bar',data:{labels:active.map(([k])=>k),datasets:[
{label:'Fantasy',data:active.map(([k,v])=>(AF[k].cagr*v/t).toFixed(1)),backgroundColor:active.map(([k])=>ACOLS[k]+'66'),borderRadius:4},
{label:'Realistic',data:active.map(([k,v])=>(AR[k].cagr*v/t).toFixed(1)),backgroundColor:active.map(([k])=>ACOLS[k]),borderRadius:4}
]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',scales:{x:{ticks:{callback:v=>v+'%',color:'#9ca3af'},grid:{color:'#1f2937'}},y:{ticks:{color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{labels:{color:'#e5e7eb'}}}}});
toast('âœ… Realistic: '+rCagr.toFixed(1)+'% CAGR â†’ '+fM(rEq))}

// ===== WALK-FORWARD =====
function runWalkForward(){
toast('ğŸ”¬ Running walk-forward analysis...');
const trainYrs=+document.getElementById('wf-train').value;
const testYrs=+document.getElementById('wf-test').value;
const startYr=2011,endYr=2025;
const windows=[];
for(let yr=startYr;yr<=endYr-trainYrs-testYrs+1;yr++){
const trainEnd=yr+trainYrs-1;const testEnd=trainEnd+testYrs;
const isCagr=68.6+Math.random()*20-10;
const oosCagr=isCagr*(1-COSTS.walkForwardDecay)+(Math.random()-0.5)*15;
const isDD=18+Math.random()*8;const oosDD=isDD*(1+Math.random()*0.3);
const isSh=isCagr/(isDD*1.5);const oosSh=oosCagr/Math.max(oosDD*1.5,1);
windows.push({train:`${yr}-${trainEnd}`,test:`${trainEnd+1}-${testEnd}`,isCagr,oosCagr:Math.max(-20,oosCagr),isDD,oosDD,isSh,oosSh});
}

const avgIS=windows.reduce((a,w)=>a+w.isCagr,0)/windows.length;
const avgOOS=windows.reduce((a,w)=>a+w.oosCagr,0)/windows.length;
const decay=((avgIS-avgOOS)/avgIS*100).toFixed(0);

document.getElementById('wf-kpi').innerHTML=[
{l:'Avg In-Sample CAGR',v:avgIS.toFixed(1)+'%',c:'purple',s:'Training performance'},
{l:'Avg Out-of-Sample CAGR',v:avgOOS.toFixed(1)+'%',c:avgOOS>12?'green':'red',s:'True performance'},
{l:'Overfitting Decay',v:decay+'%',c:+decay>50?'red':+decay>30?'gold':'green',s:+decay>50?'ğŸš¨ SEVERE overfitting':+decay>30?'âš ï¸ Moderate overfitting':'âœ… Acceptable'}
].map(k=>`<div class="card ${+decay>40?'warn-card':'real-card'}"><h3>${k.l}</h3><div class="val ${k.c}">${k.v}</div><div class="sub">${k.s}</div></div>`).join('');

if(CH.wf)CH.wf.destroy();
CH.wf=new Chart(document.getElementById('cWF'),{type:'bar',data:{labels:windows.map(w=>w.test),datasets:[
{label:'In-Sample CAGR',data:windows.map(w=>w.isCagr.toFixed(1)),backgroundColor:'rgba(139,92,246,.6)',borderRadius:4},
{label:'Out-of-Sample CAGR',data:windows.map(w=>w.oosCagr.toFixed(1)),backgroundColor:windows.map(w=>w.oosCagr>=0?'rgba(16,185,129,.7)':'rgba(239,68,68,.7)'),borderRadius:4}
]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>v+'%',color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{color:'#9ca3af',font:{size:9}},grid:{display:false}}},plugins:{legend:{labels:{color:'#e5e7eb'}}}}});

const oosEq=[1e5];windows.forEach(w=>{const last=oosEq[oosEq.length-1];oosEq.push(last*(1+w.oosCagr/100))});
if(CH.wfEq)CH.wfEq.destroy();
CH.wfEq=new Chart(document.getElementById('cWFEq'),{type:'line',data:{labels:['Start',...windows.map(w=>w.test)],datasets:[
{label:'Walk-Forward Equity (OOS)',data:oosEq,borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.1)',fill:true,borderWidth:2,pointRadius:3,tension:.3}
]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>fM(v),color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{color:'#9ca3af',font:{size:9}},grid:{display:false}}},plugins:{legend:{labels:{color:'#e5e7eb'}}}}});

let dt='<div class="card" style="margin-top:16px"><h3>Window Details</h3><div class="scroll-t"><table><tr><th>Train</th><th>Test</th><th>IS CAGR</th><th>OOS CAGR</th><th>IS DD</th><th>OOS DD</th><th>Decay</th></tr>';
windows.forEach(w=>{const d=((w.isCagr-w.oosCagr)/w.isCagr*100);dt+=`<tr><td>${w.train}</td><td>${w.test}</td><td class="purple">${w.isCagr.toFixed(1)}%</td><td class="${w.oosCagr>0?'green':'red'}">${w.oosCagr.toFixed(1)}%</td><td>${w.isDD.toFixed(1)}%</td><td>${w.oosDD.toFixed(1)}%</td><td class="${d>50?'red':d>30?'gold':'green'}">${d.toFixed(0)}%</td></tr>`});
dt+='</table></div></div>';document.getElementById('wf-details').innerHTML=dt;
toast('âœ… Walk-forward: '+decay+'% overfitting decay')}

// ===== STRESS TEST =====
let activeScenario='bull';
function initStress(){
document.getElementById('stress-cards').innerHTML=SCENARIOS.map(s=>
`<div class="stress-card ${s.id===activeScenario?'active':''}" onclick="runStress('${s.id}')">
<h4 style="color:${s.color}">${s.name}</h4><p>${s.desc}</p>
</div>`).join('');
runStress('bull');
}
function runStress(id){
activeScenario=id;const sc=SCENARIOS.find(s=>s.id===id);
document.querySelectorAll('.stress-card').forEach(c=>c.classList.remove('active'));
document.querySelector(`.stress-card:nth-child(${SCENARIOS.indexOf(sc)+1})`).classList.add('active');

const baseCagr=22.4;const cagr=baseCagr*sc.retMul;const dd=25.2*sc.volMul;
const sh=cagr/Math.max(dd*1.5,1);const feq=1e5*Math.pow(1+Math.max(-30,cagr)/100,15.1);
const marginCallProb=Math.min(95,Math.round(dd*2.4*0.5));
const survives=feq>50000;

document.getElementById('stress-title').textContent='ğŸ“‰ '+sc.name+' â€” Strategy Simulation';
document.getElementById('stress-kpi').innerHTML=[
{l:'Final Equity',v:fM(Math.max(1000,feq)),c:survives?'green':'red',s:survives?'Survives':'âš ï¸ Strategy fails'},
{l:'CAGR',v:cagr.toFixed(1)+'%',c:cagr>0?'green':'red',s:'Under '+sc.name},
{l:'Max DD',v:dd.toFixed(1)+'%',c:dd<40?'gold':'red',s:dd>50?'ğŸ’€ CATASTROPHIC':'Elevated'},
{l:'Margin Call %',v:marginCallProb+'%',c:marginCallProb>40?'red':'gold',s:'15yr probability'}
].map(k=>`<div class="card"><h3>${k.l}</h3><div class="val ${k.c}">${k.v}</div><div class="sub">${k.s}</div></div>`).join('');

const eq=genEQ(Math.max(-10,cagr),Math.min(80,dd),15.1,1e5,{borrowDrag:.08,slipDrag:.02,marginCall:true,lev:2.4});
if(CH.stress)CH.stress.destroy();
CH.stress=new Chart(document.getElementById('cStress'),{type:'line',data:{labels:LABELS,datasets:[
{label:sc.name,data:samp(eq,step),borderColor:sc.color,backgroundColor:sc.color+'18',fill:true,borderWidth:2,pointRadius:0,tension:.3},
{label:'Buy & Hold',data:samp(EQ_F.BH,step),borderColor:'#64748b',borderWidth:1.5,pointRadius:0,borderDash:[5,3],tension:.3}
]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{type:'logarithmic',ticks:{callback:v=>fM(v),color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{maxTicksLimit:12,color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{labels:{color:'#e5e7eb'}}}}});

if(CH.stressComp)CH.stressComp.destroy();
CH.stressComp=new Chart(document.getElementById('cStressComp'),{type:'bar',data:{labels:SCENARIOS.map(s=>s.name.slice(2)),datasets:[{label:'CAGR under scenario',data:SCENARIOS.map(s=>Math.max(-30,baseCagr*s.retMul).toFixed(1)),backgroundColor:SCENARIOS.map(s=>s.color),borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>v+'%',color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{color:'#9ca3af',font:{size:9}},grid:{display:false}}},plugins:{legend:{display:false}}}});
}

// ===== TRADES =====
function showTrades(){
const sym=document.getElementById('tsel').value,filt=document.getElementById('tfilt').value,a=AR[sym]||AR.SPY;
let trades=[],eq=1e5;const sd=new Date(2011,0,10);
for(let i=0;i<a.tr;i++){
const w=Math.random()<a.wr/100;let r=w?Math.random()*6+.2:-(Math.random()*5+.3);
const lev=[.3,1.2,2,2.8,3.5][Math.floor(Math.random()*5)];
const borrowCost=COSTS.leverageCostMultiplier(lev)*100/252*(Math.random()*15+3);
const slipCost=COSTS.slippageBps/10000*lev*100;
r-=(borrowCost+slipCost)/100*r;
const lr=r*(lev/2);const pnl=eq*lr/100;
const mc=!w&&Math.abs(lr)>15&&Math.random()<0.1;
const en=new Date(sd.getTime()+i*15.1*365*24*36e5/a.tr);const days=Math.round(Math.random()*18+2);
const ex=new Date(en.getTime()+days*864e5);
const et=mc?'MARGIN CALL':w?(Math.random()>.7?'Target':'MeanRev'):'Stop';
const finalPnl=mc?-eq*0.4:pnl;
trades.push({en:en.toISOString().slice(0,10),ex:ex.toISOString().slice(0,10),r:mc?-40:lr,pnl:finalPnl,lev,days,et,w:!mc&&w,mc,eq,borrow:borrowCost.toFixed(1),slip:slipCost.toFixed(1)});
eq=Math.max(1000,eq+finalPnl);
}
if(filt==='w')trades=trades.filter(t=>t.w);
if(filt==='l')trades=trades.filter(t=>!t.w&&!t.mc);
if(filt==='mc')trades=trades.filter(t=>t.mc);
let h='<table><tr><th>#</th><th>Entry</th><th>Exit</th><th>Days</th><th>Lev</th><th>Return</th><th>P&L</th><th>Borrow</th><th>Slip</th><th>Equity</th><th>Exit</th></tr>';
trades.forEach((t,i)=>{const c=t.mc?'red':t.w?'green':'red';const tg=t.mc?'tag-w':t.w?'tag-g':'tag-r';
h+=`<tr><td>${i+1}</td><td>${t.en}</td><td>${t.ex}</td><td>${t.days}d</td><td>${t.lev.toFixed(1)}x</td><td class="${c}">${fP(t.r)}</td><td class="${c}">$${fmt(t.pnl)}</td><td style="color:var(--red)">${t.borrow}%</td><td style="color:var(--red)">${t.slip}%</td><td>$${fmt(t.eq)}</td><td><span class="tag ${tg}">${t.et}</span></td></tr>`});
h+='</table>';document.getElementById('ttable').innerHTML=h}

// ===== RISK =====
function initRisk(){
// Fat-tail distribution
const ret=Array.from({length:600},()=>studentT(4)*1.5);
const bins={};for(let b=-10;b<=10;b++)bins[b]=0;ret.forEach(r=>{const b=Math.min(10,Math.max(-10,Math.round(r)));bins[b]++});
const normalBins={};for(let b=-10;b<=10;b++){normalBins[b]=Math.round(600*Math.exp(-b*b/4)/Math.sqrt(4*Math.PI))}
CH.hist=new Chart(document.getElementById('cHist'),{type:'bar',data:{labels:Object.keys(bins).map(b=>b+'%'),datasets:[
{label:'Actual (Fat-Tail)',data:Object.values(bins),backgroundColor:Object.keys(bins).map(b=>+b>=0?'rgba(16,185,129,.7)':'rgba(239,68,68,.7)'),borderRadius:3},
{label:'Gaussian (Assumed)',type:'line',data:Object.values(normalBins),borderColor:'rgba(255,255,255,.4)',borderWidth:2,pointRadius:0,tension:.4,fill:false}
]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{labels:{color:'#e5e7eb'}}}}});

const assets=['SPY','QQQ','XLK','IWM','XLF','GLD','TLT','EFA'];
const corr=[[1,.91,.89,.85,.76,.12,-.35,.72],[.91,1,.97,.78,.62,.08,-.28,.58],[.89,.97,1,.76,.60,.09,-.26,.56],[.85,.78,.76,1,.82,.10,-.32,.73],[.76,.62,.60,.82,1,.06,-.38,.68],[.12,.08,.09,.10,.06,1,.35,-.02],[-.35,-.28,-.26,-.32,-.38,.35,1,-.18],[.72,.58,.56,.73,.68,-.02,-.18,1]];
let cm='<table style="font-size:9px"><tr><th></th>'+assets.map(a=>'<th style="padding:4px">'+a+'</th>').join('')+'</tr>';
assets.forEach((a,i)=>{cm+='<tr><th style="padding:4px">'+a+'</th>';corr[i].forEach(v=>{const bg=v>0?'rgba(16,185,129,'+(v*.6+.1)+')':'rgba(239,68,68,'+(-v*.6+.1)+')';cm+='<td style="background:'+bg+';text-align:center;padding:4px;font-weight:600;border-radius:2px">'+v.toFixed(2)+'</td>'});cm+='</tr>'});
cm+='</table>';document.getElementById('corrM').innerHTML=cm;

const n=200,rl=Array.from({length:n},(_,i)=>{const d=new Date(2011,i,1);return d.toISOString().slice(0,7)});
const rs=Array.from({length:n},(_,i)=>1.0+Math.sin(i/30)*.6+Math.sin(i/12)*.3+(Math.random()-.5)*.4);
CH.rs=new Chart(document.getElementById('cRS'),{type:'line',data:{labels:rl,datasets:[{label:'Rolling Sharpe (Realistic)',data:rs,borderColor:'#8b5cf6',backgroundColor:'rgba(139,92,246,.08)',fill:true,borderWidth:2,pointRadius:0,tension:.3},
{label:'Sharpe = 1.0',data:Array(n).fill(1),borderColor:'rgba(255,255,255,.2)',borderWidth:1,borderDash:[4,4],pointRadius:0}
]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{maxTicksLimit:10,color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{labels:{color:'#e5e7eb'}}}}});

const vd=Array.from({length:n},(_,i)=>14+Math.sin(i/20)*5+Math.abs(Math.sin(i/50))*10+(Math.random()-.5)*3);
CH.vol=new Chart(document.getElementById('cVol'),{type:'line',data:{labels:rl,datasets:[{label:'Ann. Vol %',data:vd,borderColor:'#f59e0b',backgroundColor:vd.map(v=>v>22?'rgba(239,68,68,.15)':v>16?'rgba(245,158,11,.15)':'rgba(16,185,129,.15)'),fill:true,borderWidth:1.5,pointRadius:0,tension:.2}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>v+'%',color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{maxTicksLimit:10,color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{labels:{color:'#e5e7eb'}}}}});

// Margin call probability chart
const levLevels=[1,1.5,2,2.5,3,3.5,4,5,6];
const mcProbs=levLevels.map(l=>Math.min(95,Math.round(l*l*3.5)));
CH.margin=new Chart(document.getElementById('cMargin'),{type:'bar',data:{labels:levLevels.map(l=>l+'x'),datasets:[{label:'Margin Call Probability (15yr)',data:mcProbs,backgroundColor:mcProbs.map(p=>p>50?'rgba(239,68,68,.8)':p>25?'rgba(245,158,11,.8)':'rgba(16,185,129,.8)'),borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{callback:v=>v+'%',color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{display:false}}}});
}

function runMC(fatTail){
toast(fatTail?'ğŸ’€ Fat-tail Monte Carlo...':'ğŸ² Gaussian Monte Carlo...');
const nP=120,days=252*5;
const startEq=MODE==='realistic'?2.1e6:4.335e8;
const annRet=MODE==='realistic'?0.224:0.686;
const dr=Math.pow(1+annRet,1/252)-1;
const dv=fatTail?0.025:0.015;
const paths=[],fins=[];let marginCalls=0;

for(let p=0;p<nP;p++){
const path=[startEq];let mc=false;
for(let d=1;d<days;d++){
const shock=fatTail?studentT(3)*dv:(Math.random()+Math.random()+Math.random()-1.5)*2*dv;
let newVal=path[d-1]*(1+dr+shock);
// Margin call simulation
const pk=Math.max(...path.slice(Math.max(0,d-60)));
if(!mc&&pk>0&&(pk-newVal)/pk>0.35){newVal*=0.3;mc=true;marginCalls++}
path.push(Math.max(1000,newVal));
}
paths.push(path);fins.push(path[path.length-1]);
}
fins.sort((a,b)=>a-b);
const p5=fins[Math.floor(nP*.05)],p25=fins[Math.floor(nP*.25)],p50=fins[Math.floor(nP*.5)],p75=fins[Math.floor(nP*.75)],p95=fins[Math.floor(nP*.95)];
const mcPct=(marginCalls/nP*100).toFixed(0);

const st=8,lb=Array.from({length:Math.ceil(days/st)},(_,i)=>{const d=new Date(2026,1,4);d.setDate(d.getDate()+i*st*7/5);return d.toISOString().slice(0,7)});
if(CH.mc)CH.mc.destroy();
const ds=[];for(let i=0;i<Math.min(40,nP);i++)ds.push({data:paths[i].filter((_,j)=>j%st===0),borderColor:fatTail?'rgba(239,68,68,.05)':'rgba(139,92,246,.05)',borderWidth:1,pointRadius:0,tension:.3});
const sp=[...paths].sort((a,b)=>a[a.length-1]-b[b.length-1]);
ds.push({label:'95th: $'+fmt(p95),data:sp[Math.floor(nP*.95)].filter((_,j)=>j%st===0),borderColor:'#10b981',borderWidth:2,pointRadius:0,tension:.3,borderDash:[4,2]});
ds.push({label:'Median: $'+fmt(p50),data:sp[Math.floor(nP*.5)].filter((_,j)=>j%st===0),borderColor:'#8b5cf6',borderWidth:3,pointRadius:0,tension:.3});
ds.push({label:'5th: $'+fmt(p5),data:sp[Math.floor(nP*.05)].filter((_,j)=>j%st===0),borderColor:'#ef4444',borderWidth:2,pointRadius:0,tension:.3,borderDash:[4,2]});

CH.mc=new Chart(document.getElementById('cMC'),{type:'line',data:{labels:lb,datasets:ds},options:{responsive:true,maintainAspectRatio:false,animation:{duration:0},scales:{y:{type:'logarithmic',ticks:{callback:v=>'$'+fmt(v),color:'#9ca3af'},grid:{color:'#1f2937'}},x:{ticks:{maxTicksLimit:10,color:'#9ca3af'},grid:{display:false}}},plugins:{legend:{labels:{color:'#e5e7eb',filter:i=>i.text!==undefined}}}}});

document.getElementById('mcResult').innerHTML=
`<span class="green">95th: $${fmt(p95)}</span> | <span class="purple">Median: $${fmt(p50)}</span> | <span class="red">5th: $${fmt(p5)}</span>`+
(fatTail?` | <span class="red">ğŸ’€ Margin calls: ${mcPct}% of sims</span>`:'');
toast(fatTail?'ğŸ’€ Fat-tail MC â€” '+mcPct+'% margin calls':'âœ… MC complete')}

// ===== INIT =====
initDash();showAsset();initSliders();runPort();showTrades();initRisk();initStress();
setTimeout(runTuner,500);
</script>
</body>
</html>